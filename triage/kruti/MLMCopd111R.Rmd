---
title: "MLM 1909 Triage of patients with COPD exacerbation "
editor_options: null
output:
pdf_document: default
html_notebook: default
chunk_output_type: inline
---
Kruti Shah
Sept 20 2019

# Set up

```{r setup, include=FALSE}
chooseCRANmirror(graphics=FALSE, ind=1)
#require("knitr")
knitr::opts_chunk$set(echo = TRUE)
#opts_knit$set(root.dir = "C:/Users/kshah104/Documents/DSU/DSU-MLM-1909/Project Dataset/COPD Dataset/")
```


```{r}
                                                                                                                                        
############################################################################ # Install packages  and load  libraries
###########################################################################
list.of.packages <- c( "base",
                       "car", 
                      "caret", 
                      "carData",
                      "caTools",
                      "corrplot",
                      "dataMaid",
                      "dbscan",
                      "e1071",
                      "factoextra",
                      "FactoMineR",
                      "ggplot2",
                      "gplots", 
                      "grid",
                      "klaR",
                      "lattice",
                      "MASS",
                      "MLmetrics",
                      "neuralnet",
                      "plyr",
                      "pROC",
                      "randomForest",
                      "reshape2",
                      "ROCR",
                      "stats",
                      "utils")
new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
if(length(new.packages)>0) 
  {install.packages(new.packages)}





library('base')
library('car')
library('caret')
library('carData')
library('caTools')
library('corrplot')
library('dataMaid')
library('dbscan')
library('e1071')
library('factoextra')
library('FactoMineR')
library('ggplot2')
library('gplots')
library('grid')
library('klaR')
library('lattice')
library('MASS')
library('MLmetrics')
library('neuralnet')
library('plyr')
library('pROC')
library('randomForest')
library('reshape2')
library('ROCR')
library('stats')
library('utils') 

```




# 1.0 Introduction

** Business Problem ** 
 COPD affects 12.7 million Americans and costing nearly $50 billion annually. Each year, COPD leads to more than 700,000 hospitalizations
Approximately 19.6% of patients hospitalized in the United States are
readmitted within 30 days, accounting for an estimated expense of $17 billion annually . In an attempt to improve clinical outcomes and control rising healthcare costs, the Centers for Medicare and Medicaid Services (CMS) developed the Hospital Readmission Reduction Program
(HRRP), which imposes financial penalties on hospitals with excessively high readmission rates for specific conditions, such as heart failure (HF), acute myocardial infarction (AMI), and pneumonia.

 These CMS imposed penalties are geared to begin the process of moving to a patient-centric, disease management system in which the patients are trained and supported as they learn to participate in the management of their illness. To develop a tool to triaging patients with COPD to reduce the occurrence and re-occurrence of exacerbations requiring multiple hospitalizations will help Optum develop cost-saving strategies as it relates to COPD exacerbation.  

Question: Can we predict COPD exacerbations based on the provided data i.e. patient background characteristics, current clinical symptoms, and physiologic measurements using the machine learning methods? 
Based on these predictions, COPD exacerbation rapid action plan from the data can be developed.
This rapid action plan can be used to 
a.	educate and train the patient and family to self-monitor and 
b.	self-manage post discharge to lower the likelihood of unnecessary hospitalization for patients with COPD 


** Hypothesis **
Ho: There is no significant relationship between COPD exacerbation and patient profile, comorbidities, symptoms and vital signs features.

H1: COPD exacerbation can be predicted from the patient profile, comorbidities, symptoms and vital signs features.


# 2.0 Data Lineage
This problem is taken from the research paper A machine learning approach to triaging patients with chronic obstructive pulmonary disease
The dataset is extracted from the Supporting information section of the paper.
It contains 2 data sets
ÔÅ∂	Copd -This dataset if formed from the simulated data prepared by the 6 pulmonogists engaged on this experiment for the research. 
The final variable list is shown in Table 1, and includes
 1) patient background characteristics that are associated with COPD exacerbation risk and severity,
 2) current clinical symptoms that encompass widely accepted features of exacerbations, and 
3) physiologic measurements that are predicted to influence physician perception of exacerbation severity.
The Copd dataset is used for training the supervised algorithms. The Copd dataset consists of 3200 observations.



# 3.0 Data Preparation

### Load and display Data Set
```{r}
 
ctemp.att.list <- c("Id","Age",
                         "Gender",
                         "Height",
                         "Weight",
                         "Height2",
                         "RiskFactor1",
                         "RiskFactor2",
                         "RiskFactor3",
                         "RiskFactor4",
                         "BaselineDyspnea",
                         "GoldStage",
                         "ShortBreath",
                         "Cough",
                         "Wheezing",
                         "Sputum",
                         "Infection",
                         "ControllerMedication",
                         "WakeUpAtNight",
                         "CurrentDyspnea",
                         "CurrentPulseOxy",
                         "CurrentFEV1",
                         "CurrentHeartRate",
                         "CurrentTemperature",
                         "RecentWorsening",
                         "FinalTriage",
                         "Confidence1",
                         "BMI",
                         "ProfileSeverity",
                         "SymptomSeverity",
                         "VitalsSeverity",
                         "Exacerbation",
                         "FinalTriage2",
                         "Confidence2")
setwd("C:/Users/kshah104/Documents/DSU/DSU-MLM-1909/Project Dataset/COPD Dataset")
copd.temp <- read.csv("copd.csv")
#makeDataReport(copd.temp, file = "C:/Users/kshah104/Documents/DSU/DSU-MLM-1909/Project Dataset/COPD Dataset/EDAReport1.Rmd", replace = TRUE, output = "html")

copd.dr.temp <- read.csv("copd_dr.csv")
#makeDataReport(copd.dr.temp, file = "C:/Users/kshah104/Documents/DSU/DSU-MLM-1909/Project Dataset/COPD Dataset/EDAReport2.Rmd", replace = TRUE, output = "html")
copd <- copd.temp[, ctemp.att.list]
copd.dr <- copd.dr.temp[,ctemp.att.list]
copd.dr[,"Dr"] <- copd.dr.temp$Dr

#par(mar=c(1,1,1,1))


```




# 4.0 Data Cleaning

```{r}
### Remove duplicate rows from Copd dataset
nrow(copd)
sort.copd <- copd[order(copd$Id),]
copd <- sort.copd[!duplicated(copd$Id),]
nrow(copd)

### Save cleaned dataset
projectPath <- "/Users/kshah104/Documents/DSU/DSU-MLM-1909/Project Dataset/COPD Dataset/"
write.csv(copd, paste(projectPath,"copd.clean.csv", sep = ""))


```



```{r}
### Transformation of the risk factor(1-4) fields into categorical.Steps include 
# 1. Create 17 new variables in copd and copd.dr (This is because 17 different values were found in riskfactor field) 
# 2.Check the values in the risk factor field and set the value for the correct new field added.
# 3.Convert the symptomic new variables into factor type.
###--------------------------------------------------------------------

# Below are the new fields that are created and initialized to zero.The new fields are appended to the end of the dataset

copd[c("Congestive_Heart_Failure",
       "High_Blood_Pressure",
       "Coronary_Artery_Disease",
       "Diabetes",
       "Anemia",
       "Pulmonary_Hypertension",
       "Acid_Reflux",
       "Recent_Exacerbations_Hospitalizations",
       "Lives_Alone",
       "Smoker",
       "Long_Oxygen_User",
       "Assisted_Daily_Activity",
       "Hour_Recent_Worsening",
       "Sputum_Production",
       "Sputum_Color",
       "Triage_Level",
       "Triage")] <- "0"

copd.dr[c("Congestive_Heart_Failure",
       "High_Blood_Pressure",
       "Coronary_Artery_Disease",
       "Diabetes",
       "Anemia",
       "Pulmonary_Hypertension",
       "Acid_Reflux",
       "Recent_Exacerbations_Hospitalizations",
       "Lives_Alone",
       "Smoker",
       "Long_Oxygen_User",
       "Assisted_Daily_Activity",
       "Hour_Recent_Worsening",
       "Sputum_Production",
       "Sputum_Color",
       "Triage_Level",
       "Triage")] <- "0"

##-------------------------------------------------------------------------###
## Inspect RiskFactor field and based on the value found, set the         ## ## respective new field to '1'                                          ## ##
##-------------------------------------------------------------------------##
copd[grep("Heart", copd$RiskFactor1), "Congestive_Heart_Failure"] <- "1"
copd[grep("Blood", copd$RiskFactor1), "High_Blood_Pressure"] <- "1"
copd[grep("Artery", copd$RiskFactor1), "Coronary_Artery_Disease"] <- "1"
copd[grep("Diabetes", copd$RiskFactor1), "Diabetes"] <- "1"
copd[grep("Anemia", copd$RiskFactor1), "Anemia"] <- "1"
copd[grep("Pulmonary", copd$RiskFactor1), "Pulmonary_Hypertension"] <- "1"
copd[grep("Hospitalized", copd$RiskFactor1),
     "Recent_Exacerbations_Hospitalizations"] <- "1"
copd[grep("ICU", copd$RiskFactor1), "Recent_
     Exacerbations_Hospitalizations"] <- "1"
copd[grep("Exacerbations", copd$RiskFactor1),
     "Recent_Exacerbations_Hospitalizations"] <- "1"
copd[grep("Oxygen", copd$RiskFactor1), "Long_Oxygen_User"] <- "1"
copd[grep("Alone", copd$RiskFactor1), "Lives_Alone"] <- "1"
copd[grep("Help", copd$RiskFactor1),"Assisted_Daily_Activity"] <- "1"
copd[grep("Smoker", copd$RiskFactor1), "Smoker"] <- "1"
copd[grep("Acid", copd$RiskFactor1), "Acid_Reflux"] <- "1"

#----------------------RiskFactor2---------------------------------------#

copd[grep("Heart", copd$RiskFactor2), "Congestive_Heart_Failure"] <- "1"
copd[grep("Blood", copd$RiskFactor2), "High_Blood_Pressure"] <- "1"
copd[grep("Artery", copd$RiskFactor2), "Coronary_Artery_Disease"] <- "1"
copd[grep("Diabetes", copd$RiskFactor2), "Diabetes"] <- "1"
copd[grep("Anemia", copd$RiskFactor2), "Anemia"] <- "1"
copd[grep("Pulmonary", copd$RiskFactor2), "Pulmonary_Hypertension"] <- "1"
copd[grep("Hospitalized", copd$RiskFactor2),
     "Recent_Exacerbations_Hospitalizations"] <- "1"
copd[grep("ICU", copd$RiskFactor2),
     "Recent_Exacerbations_Hospitalizations"] <- "1"
copd[grep("Exacerbations", copd$RiskFactor2),
     "Recent_Exacerbations_Hospitalizations"] <- "1"
copd[grep("Oxygen", copd$RiskFactor2), "Long_Oxygen_User"] <- "1"
copd[grep("Alone", copd$RiskFactor2), "Lives_Alone"] <- "1"
copd[grep("Help", copd$RiskFactor2),"Assisted_Daily_Activity"] <- "1"
copd[grep("Smoker", copd$RiskFactor2), "Smoker"] <- "1"
copd[grep("Acid", copd$RiskFactor2), "Acid_Reflux"] <- "1"

#----------------------RiskFactor3---------------------------------------#

copd[grep("Heart", copd$RiskFactor3), "Congestive_Heart_Failure"] <- "1"
copd[grep("Blood", copd$RiskFactor3), "High_Blood_Pressure"] <- "1"
copd[grep("Artery", copd$RiskFactor3), "Coronary_Artery_Disease"] <- "1"
copd[grep("Diabetes", copd$RiskFactor3), "Diabetes"] <- "1"
copd[grep("Anemia", copd$RiskFactor3), "Anemia"] <- "1"
copd[grep("Pulmonary", copd$RiskFactor3), "Pulmonary_Hypertension"] <- "1"
copd[grep("Hospitalized", copd$RiskFactor3),
     "Recent_Exacerbations_Hospitalizations"] <- "1"
copd[grep("ICU", copd$RiskFactor3),
     "Recent_Exacerbations_Hospitalizations"] <- "1"
copd[grep("Exacerbations", copd$RiskFactor3),
     "Recent_Exacerbations_Hospitalizations"] <- "1"
copd[grep("Oxygen", copd$RiskFactor3), "Long_Oxygen_User"] <- "1"
copd[grep("Alone", copd$RiskFactor3), "Lives_Alone"] <- "1"
copd[grep("Help", copd$RiskFactor3),"Assisted_Daily_Activity"] <- "1"
copd[grep("Smoker", copd$RiskFactor3), "Smoker"] <- "1"
copd[grep("Acid", copd$RiskFactor3), "Acid_Reflux"] <- "1"

#----------------------RiskFactor4-------------------------------------#

copd[grep("Heart", copd$RiskFactor4), "Congestive_Heart_Failure"] <- "1"
copd[grep("Blood", copd$RiskFactor4), "High_Blood_Pressure"] <- "1"
copd[grep("Artery", copd$RiskFacto4), "Coronary_Artery_Disease"] <- "1"
copd[grep("Diabetes", copd$RiskFactor4), "Diabetes"] <- "1"
copd[grep("Anemia", copd$RiskFactor4), "Anemia"] <- "1"
copd[grep("Pulmonary", copd$RiskFactor4), "Pulmonary_Hypertension"] <- "1"
copd[grep("Hospitalized", copd$RiskFactor4),
     "Recent_Exacerbations_Hospitalizations"] <- "1"
copd[grep("ICU", copd$RiskFactor4),
     "Recent_Exacerbations_Hospitalizations"] <- "1"
copd[grep("Exacerbations", copd$RiskFactor4),
     "Recent_Exacerbations_Hospitalizations"] <- "1"
copd[grep("Oxygen", copd$RiskFactor4), "Long_Oxygen_User"] <- "1"
copd[grep("Alone", copd$RiskFactor4), "Lives_Alone"] <- "1"
copd[grep("Help", copd$RiskFactor4),"Assisted_Daily_Activity"] <- "1"
copd[grep("Smoker", copd$RiskFactor4), "Smoker"] <- "1"
copd[grep("Acid", copd$RiskFactor4), "Acid_Reflux"] <- "1"

#----------Convert 'Unknown' as value '2' for the symptomic fields---------#
copd[grep("Unknown", copd$RiskFactor1), "Congestive_Heart_Failure"] <- "2"
copd[grep("Unknown", copd$RiskFactor1), "High_Blood_Pressure"] <- "2"
copd[grep("Unknown", copd$RiskFactor1), "Coronary_Artery_Disease"] <- "2"
copd[grep("Unknown", copd$RiskFactor1), "Diabetes"] <- "2"
copd[grep("Unknown", copd$RiskFactor1), "Anemia"] <- "2"
copd[grep("Unknown", copd$RiskFactor1), "Pulmonary_Hypertension"] <- "2"
copd[grep("Unknown", copd$RiskFactor1),
     "Recent_Exacerbations_Hospitalizations"] <- "2"
copd[grep("Unknown", copd$RiskFactor1),
     "Recent_Exacerbations_Hospitalizations"] <- "2"
copd[grep("Unknown", copd$RiskFactor1),
     "Recent_Exacerbations_Hospitalizations"] <- "2"
copd[grep("Unknown", copd$RiskFactor1), "Long_Oxygen_User"] <- "2"
copd[grep("Unknown", copd$RiskFactor1), "Lives_Alone"] <- "2"
copd[grep("Unknown", copd$RiskFactor1),"Assisted_Daily_Activity"] <- "2"
copd[grep("Unknown", copd$RiskFactor1), "Smoker"] <- "2"
copd[grep("Unknown", copd$RiskFactor1), "Acid_Reflux"] <- "2"

#---- Converting the new symptomic fields into factor type -----------------#
copd$Congestive_Heart_Failure <- as.factor(copd$Congestive_Heart_Failure)
copd$High_Blood_Pressure <- as.factor(copd$High_Blood_Pressure)
copd$Coronary_Artery_Disease <- as.factor(copd$Coronary_Artery_Disease)
copd$Diabetes <- as.factor(copd$Diabetes)
copd$Anemia <- as.factor(copd$Anemia)
copd$Pulmonary_Hypertension <- as.factor(copd$Pulmonary_Hypertension)
copd$Recent_Exacerbations_Hospitalizations <-
  as.factor(copd$Recent_Exacerbations_Hospitalizations)
copd$Long_Oxygen_User <- as.factor(copd$Long_Oxygen_User)
copd$Lives_Alone <- as.factor(copd$Lives_Alone)
copd$Assisted_Daily_Activity <- as.factor(copd$Assisted_Daily_Activity)
copd$Smoker <- as.factor(copd$Smoker)
copd$Acid_Reflux <- as.factor(copd$Acid_Reflux)

#--------------BMI field converted into numeric from character -----------
copd$BMI <- as.numeric(copd$BMI)

#----Height field is converted into inches from feet and Height2 inches added
copd$Height <- copd$Height*12+copd$Height2



#---------Baseline Dyspnea is converted into '1','2',3'.'4'.'5' values----

copd$BaselineDyspnea <- as.character(copd$BaselineDyspnea)
copd[grep("MMRC 1", copd$BaselineDyspnea), "BaselineDyspnea"] <- "1"
copd[grep("MMRC 2", copd$BaselineDyspnea), "BaselineDyspnea"] <- "2"
copd[grep("MMRC 3", copd$BaselineDyspnea), "BaselineDyspnea"] <- "3"
copd[grep("MMRC 4", copd$BaselineDyspnea), "BaselineDyspnea"] <- "4"
copd[grep("MMRC 5", copd$BaselineDyspnea), "BaselineDyspnea"] <- "5"
copd$BaselineDyspnea <- as.factor(copd$BaselineDyspnea)

#---------GoldStage is converted into '1','2',3'.'4'.'5' values

copd$GoldStage <- as.character(copd$GoldStage)
copd[grep("GOLD STAGE 1", copd$GoldStage), "GoldStage"] <- "1"
copd[grep("GOLD STAGE 2", copd$GoldStage), "GoldStage"] <- "2"
copd[grep("GOLD STAGE 3", copd$GoldStage), "GoldStage"] <- "3"
copd[grep("GOLD STAGE 4", copd$GoldStage), "GoldStage"] <- "4"
copd[grep("GOLD STAGE 5", copd$GoldStage), "GoldStage"] <- "5"
copd[grep("Unknown", copd$GoldStage), "GoldStage"] <- "0"
copd$GoldStage <- as.factor(copd$GoldStage)

#-------Sputum is a text field which is converted into two fields Sputum Production and Sputum Color

copd[grep("Both", copd$Sputum), "Sputum_Production"] <- "1"
copd[grep("Both", copd$Sputum), "Sputum_Color"] <- "1"
copd[grep("Increased Sputum Production", copd$Sputum),
     "Sputum_Production"] <- "1"
copd[grep("Change in Sputum Color", copd$Sputum), "Sputum_Color"] <- "1"
copd$Sputum_Color <- as.factor(copd$Sputum_Color)
copd$Sputum_Production <- as.factor(copd$Sputum_Production)

#--------Short Breath field is converted into factorial values--

copd$ShortBreath <- as.character(copd$ShortBreath)
copd[grep("More than usual", copd$ShortBreath),
     "ShortBreath"] <- "More Than Usual"
copd$ShortBreath <- as.factor(copd$ShortBreath)

#---------Current Dyspnea is converted into '1','2',3'.'4'.'5' values

copd$CurrentDyspnea <- as.character(copd$CurrentDyspnea)
copd[grep("MMRC 1", copd$CurrentDyspnea), "CurrentDyspnea"] <- "1"
copd[grep("MMRC 2", copd$CurrentDyspnea), "CurrentDyspnea"] <- "2"
copd[grep("MMRC 3", copd$CurrentDyspnea), "CurrentDyspnea"] <- "3"
copd[grep("MMRC 4", copd$CurrentDyspnea), "CurrentDyspnea"] <- "4"
copd[grep("MMRC 5", copd$CurrentDyspnea), "CurrentDyspnea"] <- "5"
copd$CurrentDyspnea <- as.factor(copd$CurrentDyspnea)

#-----Tranforming the RecentWorsening text data into numeric value

copd[grep("No", copd$RecentWorsening), "Hour_Recent_Worsening"] <- "0"
copd[grep("More Than 3 days", copd$RecentWorsening),
     "Hour_Recent_Worsening"] <- "7"
copd[grep("1 To 3 Days", copd$RecentWorsening), "Hour_Recent_Worsening"] <- "3"
copd[grep("24 Hours", copd$RecentWorsening), "Hour_Recent_Worsening"] <- "1"
copd$Hour_Recent_Worsening <- as.numeric(copd$Hour_Recent_Worsening)
copd$Hour_Recent_Worsening <- mapply(function(x)
  round(24 * x * runif(1, min=0, max=1)), copd$Hour_Recent_Worsening)

#--------Controller Medication field converting 'NaN' values as 'other' 

copd$ControllerMedication <- as.character(copd$ControllerMedication)
copd[grep("NaN", copd$ControllerMedication), "ControllerMedication"] <- "Other"
copd$ControllerMedication <- as.factor(copd$ControllerMedication)

#--------CurrentPulseOxy is converted into numeric value and unknown value is converted into correct number based on the GoldStage value.


copd$CurrentPulseOxy <- as.character(copd$CurrentPulseOxy)
copd[copd$CurrentPulseOxy == "Unknown" & copd$GoldStage == "1",
     "CurrentPulseOxy"] <- "92"
copd[copd$CurrentPulseOxy == "Unknown" & copd$GoldStage == "2",
     "CurrentPulseOxy"] <- "92"
copd[copd$CurrentPulseOxy == "Unknown" & copd$GoldStage == "3",
     "CurrentPulseOxy"] <- "98"
copd[copd$CurrentPulseOxy == "Unknown" & copd$GoldStage == "4",
     "CurrentPulseOxy"] <- "87"
copd[copd$CurrentPulseOxy == "Unknown" & copd$GoldStage == "0",
     "CurrentPulseOxy"] <- "91"
copd$CurrentPulseOxy <- as.numeric(copd$CurrentPulseOxy)


#--------CurrentFEV1 is converted into numeric value and 'unknown' value is converted into correct number based on the GoldStage value.

copd$CurrentFEV1 <- as.character(copd$CurrentFEV1)

copd[copd$CurrentFEV1 == "Unknown" & copd$GoldStage == "1",
     "CurrentFEV1"] <- "80"
copd[copd$CurrentFEV1 == "Unknown" & copd$GoldStage == "2",
     "CurrentFEV1"] <- "60"
copd[copd$CurrentFEV1 == "Unknown" & copd$GoldStage == "3",
     "CurrentFEV1"] <- "40"
copd[copd$CurrentFEV1 == "Unknown" & copd$GoldStage == "4",
     "CurrentFEV1"] <- "25"
copd[copd$CurrentFEV1 == "Unknown" & copd$GoldStage == "0",
     "CurrentFEV1"] <- "55"
copd$CurrentFEV1[copd$CurrentFEV1 == '-2'] <- "25"
copd$CurrentFEV1[copd$CurrentFEV1 == '70%'] <- "70"
copd$CurrentFEV1 <- as.numeric(copd$CurrentFEV1)


#-----Current Heart Rate 'unknown' value is converted into mean value '72'

copd$CurrentHeartRate <- as.character(copd$CurrentHeartRate)
copd[grep("Unknown", copd$CurrentHeartRate), "CurrentHeartRate"] <- "72"
copd$CurrentHeartRate <- as.numeric(copd$CurrentHeartRate)

#---Current Temperature 'unknown' value is converted into normal temp range. 
copd$CurrentTemperature <- as.character(copd$CurrentTemperature)
copd[copd$CurrentTemperature == "Unknown" & copd$Infection == "No" ,
     "CurrentTemperature"] <- "98.1"
copd[copd$CurrentTemperature == "Unknown" & copd$Infection == "Yes" ,
     "CurrentTemperature"] <- "99.2"
copd$CurrentTemperature <- as.numeric(copd$CurrentTemperature)




#------Converting the negative and NULL values for confidence1 into '0' 

copd$Confidence1 <- as.character(copd$Confidence1)
copd$Confidence1[copd$Confidence1 == ''] <- "0"
copd$Confidence1[copd$Confidence1 == '-80'] <- "0"
copd$Confidence1[copd$Confidence1 == '-6'] <- "0"
copd$Confidence1[copd$Confidence1 == '790'] <- "70"
copd$Confidence1[copd$Confidence1 == '?0'] <- "0"
copd$Confidence1[is.na(copd$Confidence1)] <- "0"
copd$Confidence1 <- as.numeric(copd$Confidence1)

#------Converting the NULL values for confidence2 into '0'

copd$Confidence2 <- as.character(copd$Confidence2)
copd$Confidence2[copd$Confidence2 == ''] <- "0"
copd$Confidence2[is.na(copd$Confidence2)] <- "0"
copd$Confidence2 <- as.numeric(copd$Confidence2)

#------Converting the NULL values for Final Triage into '0'

copd$FinalTriage <- as.character(copd$FinalTriage)
copd$FinalTriage[copd$FinalTriage == ''] <- "0"
copd$FinalTriage[is.na(copd$FinalTriage)] <- "0"
copd$FinalTriage <- as.numeric(copd$FinalTriage)

#------Converting the NULL/low values for Final Triage2 into '0'

copd$FinalTriage2 <- as.character(copd$FinalTriage2)
copd$FinalTriage2[copd$FinalTriage2 == ''] <- "0"
copd$FinalTriage2[copd$FinalTriage2 == '20'] <- "0"
copd$FinalTriage2[is.na(copd$FinalTriage2)] <- "0"
copd$FinalTriage2 <- as.numeric(copd$FinalTriage2)

#--Calculate Triage = Confidence1*FinalTriage + confidence2 * FinalTriage2

copd$Triage <- as.numeric(copd$Triage)
copd$Triage <- copd$Confidence1 * copd$FinalTriage +
  copd$Confidence2 * copd$FinalTriage2
copd$Triage <- floor(copd$Triage/(copd$Confidence1+copd$Confidence2)*100)

#----Determining the triage level based on the range.
# A new variable Traige Level is created. 
# The numerical value ranges are given in the research paper.
# calculated by the following rule
# OK = < 130
# Plan = 130 ~ 245
# Doc = 245 ~ 335
# ER = > 335
###############################################################################
range.1 <- 130
range.2 <- 245
range.3 <- 335

triage.level.1 <- copd[,"Triage"] < range.1
triage.level.2 <- copd[,"Triage"] >= range.1 & copd[,"Triage"] < range.2
triage.level.3 <- copd[,"Triage"] >= range.2 & copd[,"Triage"] < range.3
triage.level.4 <- copd[,"Triage"] >= range.3

copd$Triage_Level <- as.character(copd$Triage_Level)
copd[triage.level.1,"Triage_Level"] <- "1"
copd[triage.level.2,"Triage_Level"] <- "2"
copd[triage.level.3,"Triage_Level"] <- "3"
copd[triage.level.4,"Triage_Level"] <- "4"
copd$Triage_Level <- as.factor(copd$Triage_Level)

##################################################################


#-----Dropping the record with null values in Current Dyspenea

copd$CurrentDyspnea <- as.character(copd$CurrentDyspnea)
copd <- copd[!copd$CurrentDyspnea == '',]
copd$CurrentDyspnea <- as.factor(copd$CurrentDyspnea)

#-----Converting Exacerbation to character, taking care of lowercase
copd$Exacerbation <- as.character(copd$Exacerbation)
copd$Exacerbation[copd$Exacerbation == 'n'] <- "N"
copd$Exacerbation[copd$Exacerbation == 'y'] <- "Y"
copd$Exacerbation <- as.factor(copd$Exacerbation)

copd$ProfileSeverity <- as.factor(copd$ProfileSeverity)
copd$SymptomSeverity <- as.factor(copd$SymptomSeverity)
copd$VitalsSeverity <- as.factor(copd$VitalsSeverity)


```

```{r}

###############################################################################
# Pearson test - Applying Pearson product moment test to the continuous    # independent 
# variable to test the relationship with dependent variable "Triage".  
# Chi- sq test - Applying Pearson Chisq test to the categorical independent #variables to test the relationship with the dependent variable "Triage", 
################################################################################
copd.continuous.data.profile.f <- function(data)
  {
    print(cor.test(data,copd$Triage,method="pearson" ))
  }

copd.categorical.data.profile.f <- function(data)
  {
    chisq.test(data, copd$Triage_Level, correct=FALSE)
  }

copd.categorical.data.profile.f(copd$GoldStage) # 8.596e-09
copd.categorical.data.profile.f(copd$BaselineDyspnea) # 0.00199
copd.categorical.data.profile.f(copd$Coronary_Artery_Disease) # 0.0006787
copd.categorical.data.profile.f(copd$Anemia) # 0.002235
copd.categorical.data.profile.f(copd$Pulmonary_Hypertension) # 0.001793
copd.categorical.data.profile.f(copd$ShortBreath) # 2.2e-16
copd.categorical.data.profile.f(copd$Cough) # 2.2e-16
copd.categorical.data.profile.f(copd$Wheezing) # 2.2e-16
copd.categorical.data.profile.f(copd$Sputum_Color) # 2.2e-16
copd.categorical.data.profile.f(copd$Sputum_Production) # 2.2e-16
copd.categorical.data.profile.f(copd$Infection) # 7.335e-10
copd.categorical.data.profile.f(copd$ControllerMedication) # 0.000361
copd.categorical.data.profile.f(copd$WakeUpAtNight) # 4.852e-12
copd.categorical.data.profile.f(copd$CurrentDyspnea) # 2.2e-16
copd.continuous.data.profile.f(copd$Hour_Recent_Worsening) # 4.033e-10
copd.continuous.data.profile.f(copd$CurrentPulseOxy) # 2.2e-16
copd.continuous.data.profile.f(copd$CurrentFEV1) # 2.2e-16
copd.continuous.data.profile.f(copd$CurrentHeartRate) # 2.2e-16
copd.continuous.data.profile.f(copd$CurrentTemperature) # 6.639e-15
copd.categorical.data.profile.f(copd$Acid_Reflux) # 0.003114
copd.categorical.data.profile.f(copd$Recent_Exacerbations_Hospitalizations)# 0.001117
copd.categorical.data.profile.f(copd$Diabetes) # 0.007406
copd.categorical.data.profile.f(copd$Lives_Alone) # 0.002138
copd.categorical.data.profile.f(copd$Smoker) # 0.004262
copd.categorical.data.profile.f(copd$Long_Oxygen_User) # 0.01074
copd.categorical.data.profile.f(copd$Assisted_Daily_Activity) # 0.002257
copd.categorical.data.profile.f(copd$Congestive_Heart_Failure) # 0.0094
copd.categorical.data.profile.f(copd$High_Blood_Pressure) # 0.004323

copd.continuous.data.profile.f(copd$Weight) # 0.5979
copd.continuous.data.profile.f(copd$BMI) # 0.8545
copd.continuous.data.profile.f(copd$Age) # 0.2093
copd.continuous.data.profile.f(copd$Height) # 0.3401
copd.categorical.data.profile.f(copd$Gender) # 0.1981

copd.categorical.data.profile.f(copd$ProfileSeverity) # 2.2e-16
copd.categorical.data.profile.f(copd$SymptomSeverity) # 2.2e-16
copd.categorical.data.profile.f(copd$VitalsSeverity) # 2.2e-16
copd.categorical.data.profile.f(copd$Exacerbation) # 2.2e-16
###############################################################################
# extract transformed feature set from original dataset
# extract transformed dataset - all features
# extract transformed dataset - 4 group features
###############################################################################
copd.feature <- c("GoldStage","BaselineDyspnea",
                  "Coronary_Artery_Disease","Anemia",
                  "Pulmonary_Hypertension",
                  "ShortBreath",
                  "Cough",
                  "Wheezing",
                  "Sputum_Color",
                  "Sputum_Production",
                  "Infection",
                  "ControllerMedication",
                  "WakeUpAtNight",
                  "Hour_Recent_Worsening",
                  "CurrentDyspnea",
                  "CurrentPulseOxy",
                  "CurrentFEV1",
                  "CurrentHeartRate",
                  "CurrentTemperature",
                  "Acid_Reflux",
                  "Recent_Exacerbations_Hospitalizations",
                  "Diabetes","Lives_Alone","Smoker",
                  "Long_Oxygen_User","Assisted_Daily_Activity",
                  "Congestive_Heart_Failure",
                  "High_Blood_Pressure","Triage","Triage_Level")


copd.group.feature <- c("ProfileSeverity","SymptomSeverity","VitalsSeverity",
                        "Triage","Triage_Level")


copd.group <- copd[, copd.group.feature]
copd <- copd[, copd.feature]
###########################################################################
######################################################################
# MultiCollinearity test by using Variance Inflation Rate (VIF) and Principal Component Analsis (PCA)
# VIF cutoff > 9
# PCA for dimension reduction - feature contribution
# corrplot cutoff 0.4
######################################################################
copd.pca <- copd

copd.pca$GoldStage <- as.numeric(copd.pca$GoldStage)
copd.pca$BaselineDyspnea <- as.numeric(copd.pca$BaselineDyspnea)
copd.pca$Coronary_Artery_Disease <- as.numeric(copd.pca$Coronary_Artery_Disease)
copd.pca$Anemia <- as.numeric(copd.pca$Anemia)
copd.pca$Pulmonary_Hypertension <- as.numeric(copd.pca$Pulmonary_Hypertension)
copd.pca$ShortBreath <- as.numeric(copd.pca$ShortBreath)
copd.pca$Cough <- as.numeric(copd.pca$Cough)
copd.pca$Wheezing <- as.numeric(copd.pca$Wheezing)
copd.pca$Sputum_Color <- as.numeric(copd.pca$Sputum_Color)
copd.pca$Sputum_Production <- as.numeric(copd.pca$Sputum_Production)
copd.pca$Infection <- as.numeric(copd.pca$Infection)
copd.pca$ControllerMedication <- as.numeric(copd.pca$ControllerMedication)
copd.pca$WakeUpAtNight <- as.numeric(copd.pca$WakeUpAtNight)
copd.pca$CurrentDyspnea <- as.numeric(copd.pca$CurrentDyspnea)
copd.pca$Hour_Recent_Worsening <- as.numeric(copd.pca$Hour_Recent_Worsening)
copd.pca$CurrentPulseOxy <- as.numeric(copd.pca$CurrentPulseOxy)
copd.pca$CurrentFEV1 <- as.numeric(copd.pca$CurrentFEV1)
copd.pca$CurrentHeartRate <- as.numeric(copd.pca$CurrentHeartRate)
copd.pca$CurrentTemperature <- as.numeric(copd.pca$CurrentTemperature)
copd.pca$Acid_Reflux <- as.numeric(copd.pca$Acid_Reflux)
copd.pca$Recent_Exacerbations_Hospitalizations <- as.numeric(copd.pca$Recent_Exacerbations_Hospitalizations)
copd.pca$Diabetes <- as.numeric(copd.pca$Diabetes)
copd.pca$Lives_Alone <- as.numeric(copd.pca$Lives_Alone)
copd.pca$Smoker <- as.numeric(copd.pca$Smoker)
copd.pca$Long_Oxygen_User <- as.numeric(copd.pca$Long_Oxygen_User)
copd.pca$Assisted_Daily_Activity <- as.numeric(copd.pca$Assisted_Daily_Activity)
copd.pca$Congestive_Heart_Failure <- as.numeric(copd.pca$Congestive_Heart_Failure)
copd.pca$High_Blood_Pressure <- as.numeric(copd.pca$High_Blood_Pressure)

copd.pca <- subset(copd.pca, select = -c(Triage_Level))

fit <- lm(Triage ~ ., data = copd.pca)

sqrt(vif(fit)) > 3

copd.pca <- subset(copd.pca, select = -c(Triage))

par(mfrow=c(1,1))
{plot.new(); dev.off()} 
pca.res <- PCA(copd.pca, scale.unit = TRUE, graph = FALSE)
get_eigenvalue(pca.res)
fviz_eig(pca.res, addlabels = TRUE, ylim = c(0, 20))

var <- get_pca_var(pca.res)
var.dim1 <- var$contrib[order(var$contrib[,1], decreasing = TRUE),]
var.dim1[, 1:5]

fviz_pca_var(pca.res,col.var = "contrib",
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),repel = TRUE)
{plot.new() 
  frame()
corrplot(cor(copd.pca), type="upper", order = "FPC" )
}
highlyCorrelated <- findCorrelation(cor(copd.pca), cutoff=0.4)
highlyCorCol <- colnames(copd.pca)[highlyCorrelated]
highlyCorCol


```

```{r}
 ################Preparation for Modeling Begins########################
#################################################################
# Create final training dataset
#################################################################
copd.train <- copd
#################################################################
# Create final validation dataset using the copd.dr (having doctor's inputs)
copd <- copd.dr
# Cleaning and transforming copd.dr, the same way as copd is done earlier
#################################################################
##-------------------------------------------------------------------------###
## Inspect RiskFactor field and based on the value found, set the         ## ## respective new field to '1'                                          ## ##
##-------------------------------------------------------------------------##
copd[grep("Heart", copd$RiskFactor1), "Congestive_Heart_Failure"] <- "1"
copd[grep("Blood", copd$RiskFactor1), "High_Blood_Pressure"] <- "1"
copd[grep("Artery", copd$RiskFactor1), "Coronary_Artery_Disease"] <- "1"
copd[grep("Diabetes", copd$RiskFactor1), "Diabetes"] <- "1"
copd[grep("Anemia", copd$RiskFactor1), "Anemia"] <- "1"
copd[grep("Pulmonary", copd$RiskFactor1), "Pulmonary_Hypertension"] <- "1"
copd[grep("Hospitalized", copd$RiskFactor1),
     "Recent_Exacerbations_Hospitalizations"] <- "1"
copd[grep("ICU", copd$RiskFactor1), "Recent_
     Exacerbations_Hospitalizations"] <- "1"
copd[grep("Exacerbations", copd$RiskFactor1),
     "Recent_Exacerbations_Hospitalizations"] <- "1"
copd[grep("Oxygen", copd$RiskFactor1), "Long_Oxygen_User"] <- "1"
copd[grep("Alone", copd$RiskFactor1), "Lives_Alone"] <- "1"
copd[grep("Help", copd$RiskFactor1),"Assisted_Daily_Activity"] <- "1"
copd[grep("Smoker", copd$RiskFactor1), "Smoker"] <- "1"
copd[grep("Acid", copd$RiskFactor1), "Acid_Reflux"] <- "1"

#----------------------RiskFactor2---------------------------------------#

copd[grep("Heart", copd$RiskFactor2), "Congestive_Heart_Failure"] <- "1"
copd[grep("Blood", copd$RiskFactor2), "High_Blood_Pressure"] <- "1"
copd[grep("Artery", copd$RiskFactor2), "Coronary_Artery_Disease"] <- "1"
copd[grep("Diabetes", copd$RiskFactor2), "Diabetes"] <- "1"
copd[grep("Anemia", copd$RiskFactor2), "Anemia"] <- "1"
copd[grep("Pulmonary", copd$RiskFactor2), "Pulmonary_Hypertension"] <- "1"
copd[grep("Hospitalized", copd$RiskFactor2),
     "Recent_Exacerbations_Hospitalizations"] <- "1"
copd[grep("ICU", copd$RiskFactor2),
     "Recent_Exacerbations_Hospitalizations"] <- "1"
copd[grep("Exacerbations", copd$RiskFactor2),
     "Recent_Exacerbations_Hospitalizations"] <- "1"
copd[grep("Oxygen", copd$RiskFactor2), "Long_Oxygen_User"] <- "1"
copd[grep("Alone", copd$RiskFactor2), "Lives_Alone"] <- "1"
copd[grep("Help", copd$RiskFactor2),"Assisted_Daily_Activity"] <- "1"
copd[grep("Smoker", copd$RiskFactor2), "Smoker"] <- "1"
copd[grep("Acid", copd$RiskFactor2), "Acid_Reflux"] <- "1"

#----------------------RiskFactor3---------------------------------------#

copd[grep("Heart", copd$RiskFactor3), "Congestive_Heart_Failure"] <- "1"
copd[grep("Blood", copd$RiskFactor3), "High_Blood_Pressure"] <- "1"
copd[grep("Artery", copd$RiskFactor3), "Coronary_Artery_Disease"] <- "1"
copd[grep("Diabetes", copd$RiskFactor3), "Diabetes"] <- "1"
copd[grep("Anemia", copd$RiskFactor3), "Anemia"] <- "1"
copd[grep("Pulmonary", copd$RiskFactor3), "Pulmonary_Hypertension"] <- "1"
copd[grep("Hospitalized", copd$RiskFactor3),
     "Recent_Exacerbations_Hospitalizations"] <- "1"
copd[grep("ICU", copd$RiskFactor3),
     "Recent_Exacerbations_Hospitalizations"] <- "1"
copd[grep("Exacerbations", copd$RiskFactor3),
     "Recent_Exacerbations_Hospitalizations"] <- "1"
copd[grep("Oxygen", copd$RiskFactor3), "Long_Oxygen_User"] <- "1"
copd[grep("Alone", copd$RiskFactor3), "Lives_Alone"] <- "1"
copd[grep("Help", copd$RiskFactor3),"Assisted_Daily_Activity"] <- "1"
copd[grep("Smoker", copd$RiskFactor3), "Smoker"] <- "1"
copd[grep("Acid", copd$RiskFactor3), "Acid_Reflux"] <- "1"

#----------------------RiskFactor4-------------------------------------#

copd[grep("Heart", copd$RiskFactor4), "Congestive_Heart_Failure"] <- "1"
copd[grep("Blood", copd$RiskFactor4), "High_Blood_Pressure"] <- "1"
copd[grep("Artery", copd$RiskFacto4), "Coronary_Artery_Disease"] <- "1"
copd[grep("Diabetes", copd$RiskFactor4), "Diabetes"] <- "1"
copd[grep("Anemia", copd$RiskFactor4), "Anemia"] <- "1"
copd[grep("Pulmonary", copd$RiskFactor4), "Pulmonary_Hypertension"] <- "1"
copd[grep("Hospitalized", copd$RiskFactor4),
     "Recent_Exacerbations_Hospitalizations"] <- "1"
copd[grep("ICU", copd$RiskFactor4),
     "Recent_Exacerbations_Hospitalizations"] <- "1"
copd[grep("Exacerbations", copd$RiskFactor4),
     "Recent_Exacerbations_Hospitalizations"] <- "1"
copd[grep("Oxygen", copd$RiskFactor4), "Long_Oxygen_User"] <- "1"
copd[grep("Alone", copd$RiskFactor4), "Lives_Alone"] <- "1"
copd[grep("Help", copd$RiskFactor4),"Assisted_Daily_Activity"] <- "1"
copd[grep("Smoker", copd$RiskFactor4), "Smoker"] <- "1"
copd[grep("Acid", copd$RiskFactor4), "Acid_Reflux"] <- "1"

#----------Convert 'Unknown' as value '2' for the symptomic fields---------#
copd[grep("Unknown", copd$RiskFactor1), "Congestive_Heart_Failure"] <- "2"

copd[grep("Unknown", copd$RiskFactor1), "High_Blood_Pressure"] <- "2"
copd[grep("Unknown", copd$RiskFactor1), "Coronary_Artery_Disease"] <- "2"
copd[grep("Unknown", copd$RiskFactor1), "Diabetes"] <- "2"
copd[grep("Unknown", copd$RiskFactor1), "Anemia"] <- "2"
copd[grep("Unknown", copd$RiskFactor1), "Pulmonary_Hypertension"] <- "2"
copd[grep("Unknown", copd$RiskFactor1),
     "Recent_Exacerbations_Hospitalizations"] <- "2"
copd[grep("Unknown", copd$RiskFactor1),
     "Recent_Exacerbations_Hospitalizations"] <- "2"
copd[grep("Unknown", copd$RiskFactor1),
     "Recent_Exacerbations_Hospitalizations"] <- "2"
copd[grep("Unknown", copd$RiskFactor1), "Long_Oxygen_User"] <- "2"
copd[grep("Unknown", copd$RiskFactor1), "Lives_Alone"] <- "2"
copd[grep("Unknown", copd$RiskFactor1),"Assisted_Daily_Activity"] <- "2"
copd[grep("Unknown", copd$RiskFactor1), "Smoker"] <- "2"
copd[grep("Unknown", copd$RiskFactor1), "Acid_Reflux"] <- "2"

#---- Converting the new symptomic fields into factor type -----------------#
copd$Congestive_Heart_Failure <- as.factor(copd$Congestive_Heart_Failure)
copd$High_Blood_Pressure <- as.factor(copd$High_Blood_Pressure)
copd$Coronary_Artery_Disease <- as.factor(copd$Coronary_Artery_Disease)
copd$Diabetes <- as.factor(copd$Diabetes)
copd$Anemia <- as.factor(copd$Anemia)
copd$Pulmonary_Hypertension <- as.factor(copd$Pulmonary_Hypertension)
copd$Recent_Exacerbations_Hospitalizations <-
  as.factor(copd$Recent_Exacerbations_Hospitalizations)
copd$Long_Oxygen_User <- as.factor(copd$Long_Oxygen_User)
copd$Lives_Alone <- as.factor(copd$Lives_Alone)
copd$Assisted_Daily_Activity <- as.factor(copd$Assisted_Daily_Activity)
copd$Smoker <- as.factor(copd$Smoker)
copd$Acid_Reflux <- as.factor(copd$Acid_Reflux)

#--------------BMI field converted into numeric from character -----------
copd$BMI <- as.numeric(copd$BMI)

#----Height field is converted into inches from feet and Height2 inches added
copd$Height <- copd$Height*12+copd$Height2



#---------Baseline Dyspnea is converted into '1','2',3'.'4'.'5' values----

copd$BaselineDyspnea <- as.character(copd$BaselineDyspnea)
copd[grep("MMRC 1", copd$BaselineDyspnea), "BaselineDyspnea"] <- "1"
copd[grep("MMRC 2", copd$BaselineDyspnea), "BaselineDyspnea"] <- "2"
copd[grep("MMRC 3", copd$BaselineDyspnea), "BaselineDyspnea"] <- "3"
copd[grep("MMRC 4", copd$BaselineDyspnea), "BaselineDyspnea"] <- "4"
copd[grep("MMRC 5", copd$BaselineDyspnea), "BaselineDyspnea"] <- "5"
copd$BaselineDyspnea <- as.factor(copd$BaselineDyspnea)

#---------GoldStage is converted into '1','2',3'.'4'.'5' values

copd$GoldStage <- as.character(copd$GoldStage)
copd[grep("GOLD STAGE 1", copd$GoldStage), "GoldStage"] <- "1"
copd[grep("GOLD STAGE 2", copd$GoldStage), "GoldStage"] <- "2"
copd[grep("GOLD STAGE 3", copd$GoldStage), "GoldStage"] <- "3"
copd[grep("GOLD STAGE 4", copd$GoldStage), "GoldStage"] <- "4"
copd[grep("GOLD STAGE 5", copd$GoldStage), "GoldStage"] <- "5"
copd[grep("Unknown", copd$GoldStage), "GoldStage"] <- "0"
copd$GoldStage <- as.factor(copd$GoldStage)

#-------Sputum is a text field which is converted into two fields Sputum Production and Sputum Color

copd[grep("Both", copd$Sputum), "Sputum_Production"] <- "1"
copd[grep("Both", copd$Sputum), "Sputum_Color"] <- "1"
copd[grep("Increased Sputum Production", copd$Sputum),
     "Sputum_Production"] <- "1"
copd[grep("Change in Sputum Color", copd$Sputum), "Sputum_Color"] <- "1"
copd$Sputum_Color <- as.factor(copd$Sputum_Color)
copd$Sputum_Production <- as.factor(copd$Sputum_Production)

#--------Short Breath field is converted into 0, 1, 2 categorical values--

copd$ShortBreath <- as.character(copd$ShortBreath)
copd[grep("More than usual", copd$ShortBreath),
     "ShortBreath"] <- "More Than Usual"

copd$ShortBreath <- as.factor(copd$ShortBreath)

#---------Current Dyspnea is converted into '1','2',3'.'4'.'5' values

copd$CurrentDyspnea <- as.character(copd$CurrentDyspnea)
copd[grep("MMRC 1", copd$CurrentDyspnea), "CurrentDyspnea"] <- "1"
copd[grep("MMRC 2", copd$CurrentDyspnea), "CurrentDyspnea"] <- "2"
copd[grep("MMRC 3", copd$CurrentDyspnea), "CurrentDyspnea"] <- "3"
copd[grep("MMRC 4", copd$CurrentDyspnea), "CurrentDyspnea"] <- "4"
copd[grep("MMRC 5", copd$CurrentDyspnea), "CurrentDyspnea"] <- "5"
copd$CurrentDyspnea <- as.factor(copd$CurrentDyspnea)

#-----Tranforming the RecentWorsening text data into numeric value

copd[grep("No", copd$RecentWorsening), "Hour_Recent_Worsening"] <- "0"
copd[grep("More Than 3 days", copd$RecentWorsening),
     "Hour_Recent_Worsening"] <- "7"
copd[grep("1 To 3 Days", copd$RecentWorsening), "Hour_Recent_Worsening"] <- "3"
copd[grep("24 Hours", copd$RecentWorsening), "Hour_Recent_Worsening"] <- "1"
copd$Hour_Recent_Worsening <- as.numeric(copd$Hour_Recent_Worsening)
copd$Hour_Recent_Worsening <- mapply(function(x)
  round(24 * x * runif(1, min=0, max=1)), copd$Hour_Recent_Worsening)

#--------Controller Medication field converting 'NaN' values as 'other' 

copd$ControllerMedication <- as.character(copd$ControllerMedication)
copd[grep("NaN", copd$ControllerMedication), "ControllerMedication"] <- "Other"
copd$ControllerMedication <- as.factor(copd$ControllerMedication)

#--------CurrentPulseOxy is converted into numeric value and unknown value is converted into correct number based on the GoldStage value.


copd$CurrentPulseOxy <- as.character(copd$CurrentPulseOxy)
copd[copd$CurrentPulseOxy == "Unknown" & copd$GoldStage == "1",
     "CurrentPulseOxy"] <- "92"
copd[copd$CurrentPulseOxy == "Unknown" & copd$GoldStage == "2",
     "CurrentPulseOxy"] <- "92"
copd[copd$CurrentPulseOxy == "Unknown" & copd$GoldStage == "3",
     "CurrentPulseOxy"] <- "98"
copd[copd$CurrentPulseOxy == "Unknown" & copd$GoldStage == "4",
     "CurrentPulseOxy"] <- "87"
copd[copd$CurrentPulseOxy == "Unknown" & copd$GoldStage == "0",
     "CurrentPulseOxy"] <- "91"
copd$CurrentPulseOxy <- as.numeric(copd$CurrentPulseOxy)


#--------CurrentFEV1 is converted into numeric value and 'unknown' value is converted into correct number based on the GoldStage value.

copd$CurrentFEV1 <- as.character(copd$CurrentFEV1)

copd[copd$CurrentFEV1 == "Unknown" & copd$GoldStage == "1",
     "CurrentFEV1"] <- "80"
copd[copd$CurrentFEV1 == "Unknown" & copd$GoldStage == "2",
     "CurrentFEV1"] <- "60"
copd[copd$CurrentFEV1 == "Unknown" & copd$GoldStage == "3",
     "CurrentFEV1"] <- "40"
copd[copd$CurrentFEV1 == "Unknown" & copd$GoldStage == "4",
     "CurrentFEV1"] <- "25"
copd[copd$CurrentFEV1 == "Unknown" & copd$GoldStage == "0",
     "CurrentFEV1"] <- "55"
copd$CurrentFEV1[copd$CurrentFEV1 == '-2'] <- "25"
copd$CurrentFEV1[copd$CurrentFEV1 == '70%'] <- "70"
copd$CurrentFEV1 <- as.numeric(copd$CurrentFEV1)


#-----Current Heart Rate 'unknown' value is converted into mean value '72'

copd$CurrentHeartRate <- as.character(copd$CurrentHeartRate)
copd[grep("Unknown", copd$CurrentHeartRate), "CurrentHeartRate"] <- "72"
copd$CurrentHeartRate <- as.numeric(copd$CurrentHeartRate)

#---Current Temperature 'unknown' value is converted into normal temp range. 
copd$CurrentTemperature <- as.character(copd$CurrentTemperature)
copd[copd$CurrentTemperature == "Unknown" & copd$Infection == "No" ,
     "CurrentTemperature"] <- "98.1"
copd[copd$CurrentTemperature == "Unknown" & copd$Infection == "Yes" ,
     "CurrentTemperature"] <- "99.2"
copd$CurrentTemperature <- as.numeric(copd$CurrentTemperature)

#------Converting the negative and NULL values for confidence1 into '0' 

copd$Confidence1 <- as.character(copd$Confidence1)
copd$Confidence1[copd$Confidence1 == ''] <- "0"
copd$Confidence1[copd$Confidence1 == '-80'] <- "0"
copd$Confidence1[copd$Confidence1 == '-6'] <- "0"
copd$Confidence1[copd$Confidence1 == '790'] <- "70"
copd$Confidence1[copd$Confidence1 == '?0'] <- "0"
copd$Confidence1[is.na(copd$Confidence1)] <- "0"
copd$Confidence1 <- as.numeric(copd$Confidence1)

#------Converting the NULL values for confidence2 into '0'

copd$Confidence2 <- as.character(copd$Confidence2)
copd$Confidence2[copd$Confidence2 == ''] <- "0"
copd$Confidence2[is.na(copd$Confidence2)] <- "0"
copd$Confidence2 <- as.numeric(copd$Confidence2)

#------Converting the NULL values for Final Triage into '0'

copd$FinalTriage <- as.character(copd$FinalTriage)
copd$FinalTriage[copd$FinalTriage == ''] <- "0"
copd$FinalTriage[is.na(copd$FinalTriage)] <- "0"
copd$FinalTriage <- as.numeric(copd$FinalTriage)

#------Converting the NULL values for Final Triage2 into '0'

copd$FinalTriage2 <- as.character(copd$FinalTriage2)
copd$FinalTriage2[copd$FinalTriage2 == ''] <- "0"
copd$FinalTriage2[copd$FinalTriage2 == '20'] <- "0"
copd$FinalTriage2[is.na(copd$FinalTriage2)] <- "0"
copd$FinalTriage2 <- as.numeric(copd$FinalTriage2)

#--Calculate Triage = Confidence1*FinalTriage + confidence2 * FinalTriage2

copd$Triage <- as.numeric(copd$Triage)
copd$Triage <- copd$Confidence1 * copd$FinalTriage +
  copd$Confidence2 * copd$FinalTriage2
 copd$Triage <- floor(copd$Triage/(copd$Confidence1+copd$Confidence2)*100)

#----Determining the triage level based on the range.
# A new variable Traige Level is created. 
# The numerical value ranges are given in the research paper.
# calculated by the following rule
# OK = < 130
# Plan = 130 ~ 245
# Doc = 245 ~ 335
# ER = > 335
###############################################################################
range.1 <- 130
range.2 <- 245
range.3 <- 335
triage.level.1 <- copd[,"Triage"] < range.1
triage.level.2 <- copd[,"Triage"] >= range.1 & copd[,"Triage"] < range.2
triage.level.3 <- copd[,"Triage"] >= range.2 & copd[,"Triage"] < range.3
triage.level.4 <- copd[,"Triage"] >= range.3

copd$Triage_Level <- as.character(copd$Triage_Level)
copd[triage.level.1,"Triage_Level"] <- "1"
copd[triage.level.2,"Triage_Level"] <- "2"
copd[triage.level.3,"Triage_Level"] <- "3"
copd[triage.level.4,"Triage_Level"] <- "4"
copd$Triage_Level <- as.factor(copd$Triage_Level)

#-----Dropping the record with null values in Current Dyspenea

copd$CurrentDyspnea <- as.character(copd$CurrentDyspnea)
copd <- copd[!copd$CurrentDyspnea == '',]
copd$CurrentDyspnea <- as.factor(copd$CurrentDyspnea)

#-----Converting Exacerbation to character, taking care of lowercase
copd$Exacerbation <- as.character(copd$Exacerbation)
copd$Exacerbation[copd$Exacerbation == 'n'] <- "N"
copd$Exacerbation[copd$Exacerbation == 'y'] <- "Y"
copd$Exacerbation <- as.factor(copd$Exacerbation)

copd$ProfileSeverity <- as.factor(copd$ProfileSeverity)
copd$SymptomSeverity <- as.factor(copd$SymptomSeverity)
copd$VitalsSeverity <- as.factor(copd$VitalsSeverity)
copd.dr <- copd

copd.test <- copd.dr[, copd.feature]

###############################################################################
# create final test data - 100 petients
###############################################################################
copd.validation <- copd.dr[copd.dr$Dr == "9",]
###############################################################################
# profiling datasets
###############################################################################
dim(copd.train)
dim(copd.test)
dim(copd.validation)

###############################################################################
# get feature importance based on linear regression 
###############################################################################
set.seed(1234)
copd.final.train <- subset(copd.train, select = -c(Triage_Level))
copd.final.test <- subset(copd.validation, select = -c(Triage_Level))
copd.lr.traincontrol <- trainControl( method="cv",
                                       verboseIter = TRUE)
LRegression <- train(Triage ~ ., data = copd.final.train, method = "lm",
            trControl = copd.lr.traincontrol)

ImpLR <- varImp(LRegression, scale = TRUE)
plot(ImpLR)

###############################################################################
# get feature importance based on Random Forest 
#########################################################################
#set.seed(1234)
#copd.rf.traincontrol <- trainControl(  method="cv",
  #                                     verboseIter = TRUE,
 #                                      preProcOptions = "bagImpute"
 #                                    )
#RForest <- train(Triage ~ ., data = copd.final.train, method = "rf", importance=T,trControl = copd.rf.traincontrol)
#ImpRF <- varImp(RForest, scale = TRUE)
#plot(ImpRF, cex.axis =0.5, col.axis = 3)

###################################################
# Random forest with important features
###################################################
#rf.feature <- c(
#  "ShortBreath",
 # "Cough",
  #"Hour_Recent_Worsening",
 # "Wheezing",
#  "Sputum_Color",
 # "Sputum_Production",
  #"CurrentDyspnea",
  #"CurrentPulseOxy",
  #"CurrentFEV1",
  #"CurrentHeartRate",
  #"CurrentTemperature",
  #"Triage_Level")

#set.seed(1234)
#copd.final.train <- copd.train[, rf.feature]
#copd.final.test <- copd.validation[, rf.feature]

#copd.rf.traincontrol <- trainControl( method="cv",
 #                                     verboseIter = TRUE,
#                                      preProcOptions = "bagImpute")

#RForest <- train(Triage_Level ~ ., data = copd.final.train, method = #"rf", importance=T, copd.rf.traincontrol, verboseIter = TRUE)

#rf.predict <- predict(RForest, copd.final.test, type = 'raw')

#confusionMatrix(rf.predict, copd.final.test$Triage_Level)

#ImpRF <- varImp(RForest, scale = TRUE)
#plot(ImpRF, cex.axis =0.3, col.axis = 4)


# MODELING BEGINS

###############################################################################
############--KNN MODELING Begins HERE ################################### 


########################################################
# KNN all features
########################################################

set.seed(1234)
copd.final.train <- subset(copd.train, select = -c(Triage))
copd.final.test <- subset(copd.validation, select = -c(Triage))

levels(copd.final.train$Triage_Level) <- c("Ok", "Plan", "Doc", "ER")
levels(copd.final.test$Triage_Level) <- c("Ok", "Plan", "Doc", "ER")

## ---------Repeated Cross validation is chosen as the method below-----
copd.knn.traincontrol <- trainControl(
  method="repeatedcv",repeats = 3,
  classProbs = TRUE,
  verboseIter = TRUE
 )

gl <- train(Triage_Level ~ .,
            data = copd.final.train,
            method = "knn",
            preProcess = c('center', 'scale'),
            trControl = copd.knn.traincontrol,
            tuneLength = 10)

gl.predict <- predict(gl, copd.final.test, type = 'raw')

confusionMatrix(gl.predict, copd.final.test$Triage_Level)


##############################################
# KNN with 16  important features
##############################################

knn.feature <- c("GoldStage",
                   "ShortBreath",
                   "Cough",
                   "Wheezing",
                   "Sputum_Color",
                   "Sputum_Production",
                   "Infection",
                   "ControllerMedication",
                   "WakeUpAtNight",
                   "Hour_Recent_Worsening",
                   "CurrentDyspnea",
                   "CurrentPulseOxy",
                   "CurrentFEV1",
                   "CurrentHeartRate",
                   "CurrentTemperature",
                   "Triage_Level")


set.seed(1234)
copd.knn.train <- copd.train[, knn.feature]
copd.knn.test <- copd.validation[, knn.feature]

levels(copd.knn.train$Triage_Level) <- c("Ok", "Plan", "Doc", "ER")
levels(copd.knn.test$Triage_Level) <- c("Ok", "Plan", "Doc", "ER")

copd.knn.traincontrol <- trainControl(
  method="repeatedcv",repeats = 3,
  classProbs = TRUE,
  verboseIter = TRUE
)

gl <- train(Triage_Level ~ .,
            data = copd.knn.train,
            method = "knn",
            preProcess = c('center', 'scale'),
            trControl = copd.knn.traincontrol,
            tuneLength = 10)

gl.predict <- predict(gl, copd.knn.test, type = 'raw')

confusionMatrix(gl.predict, copd.knn.test$Triage_Level)

plot(gl)

#-----------------------------------------------------------------
##############################################
# KNN with (8+4) important features
#############################################

knn.feature <- c(
                 "ShortBreath",
                 "Cough",
                 "Wheezing",
                 "Sputum_Color",
                 "Sputum_Production",
                 "Hour_Recent_Worsening",
                 "CurrentDyspnea",
                 "CurrentPulseOxy",
                 "CurrentFEV1",
                 "CurrentHeartRate",
                 "CurrentTemperature",
                 "Triage_Level")


set.seed(1234)
copd.knn.train <- copd.train[, knn.feature]
copd.knn.test <- copd.validation[, knn.feature]

levels(copd.knn.train$Triage_Level) <- c("Ok", "Plan", "Doc", "ER")
levels(copd.knn.test$Triage_Level) <- c("Ok", "Plan", "Doc", "ER")

copd.knn.traincontrol <- trainControl(
  method="repeatedcv",repeats = 3,
  classProbs = TRUE,
  verboseIter = TRUE
)

gl <- train(Triage_Level ~ .,
            data = copd.knn.train,
            method = "knn",
            preProcess = c('center', 'scale'),
            trControl = copd.knn.traincontrol,
            tuneLength = 10)

gl.predict <- predict(gl, copd.knn.test, type = 'raw')

confusionMatrix(gl.predict, copd.knn.test$Triage_Level)

plot(gl)



##############################################
# KNN with (8+5) important features
#############################################

knn.feature <- c(
                 "ShortBreath",
                 "Cough",
                 "Wheezing",
                 "Sputum_Color",
                 "Sputum_Production",
                 "Hour_Recent_Worsening",
                 "CurrentDyspnea",
                 "CurrentPulseOxy",
                 "CurrentFEV1",
                 "CurrentHeartRate",
                 "CurrentTemperature",
                 "Triage",
                 "Triage_Level")


set.seed(1234)
copd.knn.train <- copd.train[, knn.feature]
copd.knn.test <- copd.validation[, knn.feature]

levels(copd.knn.train$Triage_Level) <- c("Ok", "Plan", "Doc", "ER")
levels(copd.knn.test$Triage_Level) <- c("Ok", "Plan", "Doc", "ER")

copd.knn.traincontrol <- trainControl(
  method="repeatedcv",repeats = 3,
  classProbs = TRUE,
  verboseIter = TRUE
)

gl <- train(Triage_Level ~ .,
            data = copd.knn.train,
            method = "knn",
            preProcess = c('center', 'scale'),
            trControl = copd.knn.traincontrol,
            tuneLength = 10)

gl.predict <- predict(gl, copd.knn.test, type = 'raw')

confusionMatrix(gl.predict, copd.knn.test$Triage_Level)

plot(gl)




```

```{r}
###############################################################################
# SVM linear
###############################################################################
grid <- expand.grid(C = c(0.01, 0.05, 0.1, 0.25, 0.5, 0.75, 1, 1.25, 1.5, 1.75, 2, 5))
set.seed(1234)
copd.final.train <- subset(copd.train, select = -c(Triage))
copd.final.test <- subset(copd.validation, select = -c(Triage))

levels(copd.final.train$Triage_Level) <- c("Ok", "Plan", "Doc", "ER")
levels(copd.final.test$Triage_Level) <- c("Ok", "Plan", "Doc", "ER")

copd.svm.traincontrol <- trainControl(
  method="repeatedcv",repeats = 3, number = 5,
  classProbs = TRUE,
  verboseIter = TRUE
)

svml <- train(Triage_Level ~ .,
            data = copd.final.train,
            method = "svmLinear",
            preProcess = c('center', 'scale'),
            trControl = copd.svm.traincontrol,
            tuneGrid = grid,
            tuneLength = 5)

print(svml)

svml.predict <- predict(svml, copd.final.test, type = 'raw')

confusionMatrix(svml.predict, copd.final.test$Triage_Level)

plot(svml)

###############################################################################
# SVM Non-linear
###############################################################################
set.seed(1234)
copd.final.train <- subset(copd.train, select = -c(Triage))
copd.final.test <- subset(copd.validation, select = -c(Triage))

levels(copd.final.train$Triage_Level) <- c("Ok", "Plan", "Doc", "ER")
levels(copd.final.test$Triage_Level) <- c("Ok", "Plan", "Doc", "ER")

copd.svm.traincontrol <- trainControl(
  method="repeatedcv",repeats = 2 , number = 5,
  classProbs = TRUE,
  verboseIter = TRUE
)

svmnl <- train(Triage_Level ~ .,
            data = copd.final.train,
            method = "svmRadial",
            preProcess = c('center', 'scale'),
            trControl = copd.svm.traincontrol,
            tuneLength = 5)

print(svmnl)

svmnl.predict <- predict(svmnl, copd.final.test, type = 'raw')

confusionMatrix(svmnl.predict, copd.final.test$Triage_Level)

plot(svmnl)

###############################################################################
# SVM Polynomial Kernel
###############################################################################
grid <- expand.grid(C = c(0.25), degree = c(1,2,3), scale = (0.01))
set.seed(1234)
copd.final.train <- subset(copd.train, select = -c(Triage))
copd.final.test <- subset(copd.validation, select = -c(Triage))

levels(copd.final.train$Triage_Level) <- c("Ok", "Plan", "Doc", "ER")
levels(copd.final.test$Triage_Level) <- c("Ok", "Plan", "Doc", "ER")

copd.svm.traincontrol <- trainControl(
  method="repeatedcv",repeats = 2, number = 5,
  classProbs = TRUE,
  verboseIter = TRUE
)

svmpoly <- train(Triage_Level ~ .,
            data = copd.final.train,
            method = "svmPoly",
            preProcess = c('center', 'scale'),
            trControl = copd.svm.traincontrol,
            tuneGrid = grid,
            tuneLength = 5)

print(svmpoly)

svmpoly.predict <- predict(svmpoly, copd.final.test, type = 'raw')

confusionMatrix(svmpoly.predict, copd.final.test$Triage_Level)

plot(svmpoly)
###############################################################################
# SVM e1071 - All Features
###############################################################################
normalize <- function(x) {
  x <- as.numeric(x)
  return ((x - min(x)) / (max(x) - min(x)))
}

copd.final.train <- subset(copd.train, select = -c(Triage))
copd.final.test <- subset(copd.validation, select = -c(Triage))

copd.final.train <- as.data.frame(lapply(copd.final.train, normalize))
copd.final.test <- as.data.frame(lapply(copd.final.test, normalize))

copd.final.train$Triage_Level = as.factor(copd.final.train$Triage_Level)
copd.final.test$Triage_Level = as.factor(copd.final.test$Triage_Level)

levels(copd.final.train$Triage_Level) <- c("Ok", "Plan", "Doc", "ER")
levels(copd.final.test$Triage_Level) <- c("Ok", "Plan", "Doc", "ER")

svme <- svm(Triage_Level~., copd.final.train, kernel='linear',
          cross = 10, cost=0.15, scale = FALSE)
summary(svme)

svme.predict <- predict(svme, newdata=copd.final.test)

copd.final.test = na.omit(copd.final.test)

confusionMatrix(svme.predict, copd.final.test$Triage_Level)

plot(svme, copd.final.train, Hour_Recent_Worsening~CurrentHeartRate)


###############################################################################
# SVM e1071 - 16 Features
###############################################################################
svm.feature <- c("GoldStage",
                   "ShortBreath",
                   "Cough",
                   "Wheezing",
                   "Sputum_Color",
                   "Sputum_Production",
                   "Infection",
                   "ControllerMedication",
                   "WakeUpAtNight",
                   "Hour_Recent_Worsening",
                   "CurrentDyspnea",
                   "CurrentPulseOxy",
                   "CurrentFEV1",
                   "CurrentHeartRate",
                   "CurrentTemperature",
                   "Triage_Level")


set.seed(1234)
normalize <- function(x) {
  x <- as.numeric(x)
  return ((x - min(x)) / (max(x) - min(x)))
}
copd.final.train <- copd.train[, svm.feature]
copd.final.test <- copd.validation[, svm.feature]


copd.final.train <- as.data.frame(lapply(copd.final.train, normalize))
copd.final.test <- as.data.frame(lapply(copd.final.test, normalize))

copd.final.train$Triage_Level = as.factor(copd.final.train$Triage_Level)
copd.final.test$Triage_Level = as.factor(copd.final.test$Triage_Level)

levels(copd.final.train$Triage_Level) <- c("Ok", "Plan", "Doc", "ER")
levels(copd.final.test$Triage_Level) <- c("Ok", "Plan", "Doc", "ER")

svme <- svm(Triage_Level~., copd.final.train, kernel='linear',
          cross = 10, cost=0.15, scale = FALSE)
summary(svme)

svme.predict <- predict(svme, newdata=copd.final.test)

copd.final.test = na.omit(copd.final.test)

confusionMatrix(svme.predict, copd.final.test$Triage_Level)

plot(svme, copd.final.train, Hour_Recent_Worsening~CurrentHeartRate)



```


```{r}
##################################################
# Naive Bayes
##################################################
set.seed(1234)
copd.final.train <- subset(copd.train, select = -c(Triage))
copd.final.test <- subset(copd.validation, select = -c(Triage))

levels(copd.final.train$Triage_Level) <- c("Ok", "Plan", "Doc", "ER")
levels(copd.final.test$Triage_Level) <- c("Ok", "Plan", "Doc", "ER")

copd.nb.traincontrol <- trainControl(
  method = 'cv',
  number = 10,
  classProbs = TRUE,
  verboseIter = TRUE
)

NBayes   <- train(Triage_Level ~ .,
            data = copd.final.train,
            method = "nb",
            preProcess = c('center', 'scale'),
            trControl = copd.nb.traincontrol)

nb.predict <- predict(NBayes, copd.final.test, type = 'raw')

confusionMatrix(nb.predict, copd.final.test$Triage_Level)

########################################################
# Naive Bayes importance
########################################################
nb.feature <- c(
  "ShortBreath",
  "Cough",
  "Hour_Recent_Worsening",
  "Wheezing",
  "Sputum_Color",
  "Sputum_Production",
  "CurrentDyspnea",
  "CurrentPulseOxy",
  "CurrentFEV1",
  "CurrentHeartRate",
  "CurrentTemperature",
  "Triage_Level")

set.seed(1234)
copd.nb.train <- copd.train[, nb.feature]
copd.nb.test <- copd.validation[, nb.feature]

levels(copd.nb.train$Triage_Level) <- c("Ok", "Plan", "Doc", "ER")
levels(copd.nb.test$Triage_Level) <- c("Ok", "Plan", "Doc", "ER")

copd.nb.traincontrol <- trainControl(
  method = 'cv',
  number = 10,
  classProbs = TRUE,
  verboseIter = TRUE
)

NBayes <- train(Triage_Level ~ .,
            data = copd.nb.train,
            method = "nb",
            preProcess = c('center', 'scale'),
            trControl = copd.nb.traincontrol)

nb.predict <- predict(NBayes, copd.nb.test, type = 'raw')

confusionMatrix(nb.predict, copd.nb.test$Triage_Level)

```
```{r}
###############################################################################
# Neural network
###############################################################################
set.seed(1234)
copd.final.train <- subset(copd.train, select = -c(Triage))
copd.final.test <- subset(copd.validation, select = -c(Triage))

levels(copd.final.train$Triage_Level) <- c("Ok", "Plan", "Doc", "ER")
levels(copd.final.test$Triage_Level) <- c("Ok", "Plan", "Doc", "ER")

copd.nnet.traincontrol <- trainControl(
  method = 'cv',
  number = 10,
  classProbs = TRUE,
  verboseIter = TRUE,
  preProcOptions = list(thresh = 0.01, ICAcomp = 3, k = 5))

ANN <- train(Triage_Level ~ .,
            data = copd.final.train,
            method = "nnet",
            metric = "ROC",
            preProcess = c('center', 'scale'),
            trControl = copd.nnet.traincontrol,
            tuneGrid = expand.grid(size=c(10), decay=c(0.1)))

ANN.predict <- predict(ANN, copd.final.test, type = 'raw')

confusionMatrix(ANN.predict, copd.final.test$Triage_Level)

###############################################################################
# Neural network - multiple classes
###############################################################################
set.seed(1234)

normalize <- function(x) {
  x <- as.numeric(x)
  return ((x - min(x)) / (max(x) - min(x)))
}

copd.final.train <- subset(copd.train, select = -c(Triage))
copd.final.test <- subset(copd.validation, select = -c(Triage))

copd.final.train <- as.data.frame(lapply(copd.final.train, normalize))
copd.final.test <- as.data.frame(lapply(copd.final.test, normalize))

copd.final.train$Triage_Level <- as.factor(copd.final.train$Triage_Level)
copd.final.test$Triage_Level <- as.factor(copd.final.test$Triage_Level)
levels(copd.final.train$Triage_Level) <- c("Ok", "Plan", "Doc", "ER")
levels(copd.final.test$Triage_Level) <- c("Ok", "Plan", "Doc", "ER")

copd.final.train$Triage_Level_Ok <- copd.final.train$Triage_Level == "Ok"
copd.final.train$Triage_Level_Plan <- copd.final.train$Triage_Level == "Plan"
copd.final.train$Triage_Level_Doc <- copd.final.train$Triage_Level == "Doc"
copd.final.train$Triage_Level_ER <- copd.final.train$Triage_Level == "ER"


copd.final.test.temp <- subset(copd.final.test, select = -c(Triage_Level))

allVar <- colnames(copd.final.train)
predictor.var = allVar[!allVar%in% c("Triage_Level", "Triage_Level_Plan",
                                     "Triage_Level_Doc", "Triage_Level_Ok",
                                     "Triage_Level_ER")]

predictor.var = paste(predictor.var, collapse = "+")
form=as.formula(paste("Triage_Level_Ok + Triage_Level_Plan +
                      Triage_Level_Doc + Triage_Level_ER~",
                      predictor.var, collapse = "+"))

ANN <- neuralnet(formula = form, hidden = 6, linear.output = FALSE,
                data = copd.final.train, act.fct = "logistic", stepmax=1e6)

#dev.off()

#plot(ANN)

ANN$result.matrix

ANN.predict <- compute(ANN, copd.final.test.temp)

df <- as.data.frame(ANN.predict$net.result)
df <- rename(df, c("V1"="Ok", "V2"="Plan", "V3"="Doc", "V4"="ER"))
df$Triage_Level_pred <- "Ok"
df$Triage_Level_pred <- names(df)[apply(df,1,which.max)]

df$Triage_Level_pred <- as.factor(df$Triage_Level_pred)
df$Triage_Level_pred <- factor(df$Triage_Level_pred, levels = c("Ok", "Plan", "Doc", "ER"))

levels(df$Triage_Level_pred)
levels(copd.final.test$Triage_Level)

confusionMatrix(df$Triage_Level_pred, copd.final.test$Triage_Level)

###############################################################################
# Neural network - linear outpot
# one layer - 0 ~ 9 hidden nodes
# two layers - 6 nodes layer1 and 3 nodes layer2
###############################################################################
set.seed(1234)

normalize <- function(x) {
  x <- as.numeric(x)
  return ((x - min(x)) / (max(x) - min(x)))
}

copd.final.train <- subset(copd.train, select = -c(Triage_Level))
copd.final.test <- subset(copd.validation, select = -c(Triage_Level))

copd.final.train <- as.data.frame(lapply(copd.final.train, normalize))
copd.final.test <- as.data.frame(lapply(copd.final.test, normalize))

copd.final.test.temp <- subset(copd.final.test, select = -c(Triage))

allVar <- colnames(copd.final.train)
predictor.var = allVar[!allVar%in% c("Triage")]

predictor.var = paste(predictor.var, collapse = "+")
form=as.formula(paste("Triage~",
                      predictor.var, collapse = "+"))

ANN <- neuralnet(formula = form, hidden = 6, linear.output = FALSE,
                data = copd.final.train, threshold=0.01, stepmax=1e6)

#dev.off()
#plot(ANN)

ANN$result.matrix

ANN.predict <- compute(ANN, copd.final.test.temp)

ANN.predict$net.result

copd.final.test$Triage

rmse <- sqrt(mean((ANN.predict$net.result - copd.final.test$Triage)^2))

###############################################################################
# Neural network - single output 5,3
###############################################################################
set.seed(1234)

normalize <- function(x) {
  x <- as.numeric(x)
  return ((x - min(x)) / (max(x) - min(x)))
}

copd.final.train <- subset(copd.train, select = -c(Triage_Level))
copd.final.test <- subset(copd.validation, select = -c(Triage_Level))

copd.final.train <- as.data.frame(lapply(copd.final.train, normalize))
copd.final.test <- as.data.frame(lapply(copd.final.test, normalize))

copd.final.test.temp <- subset(copd.final.test, select = -c(Triage))

allVar <- colnames(copd.final.train)
predictor.var = allVar[!allVar%in% c("Triage")]

predictor.var = paste(predictor.var, collapse = "+")
form=as.formula(paste("Triage~",
                      predictor.var, collapse = "+"))

ANN <- neuralnet(formula = form, hidden = c(5,3), linear.output = FALSE,
                data = copd.final.train, threshold=0.01)

#dev.off()

# plot(ANN)

ANN$result.matrix

ANN.predict <- compute(ANN, copd.final.test.temp)

ANN.predict$net.result

copd.final.test$Triage

rmse <- sqrt(mean((ANN.predict$net.result - copd.final.test$Triage)^2))

```
```{r}
###############################################################################
# XGboost - Tree
###############################################################################
set.seed(1234)
copd.final.train <- subset(copd.train, select = -c(Triage))
copd.final.test <- subset(copd.validation, select = -c(Triage))

levels(copd.final.train$Triage_Level) <- c("Ok", "Plan", "Doc", "ER")
levels(copd.final.test$Triage_Level) <- c("Ok", "Plan", "Doc", "ER")

copd.xgb.traincontrol <- trainControl(
  method = 'cv',
  number = 5,
  classProbs = TRUE,
  verboseIter = TRUE)

xgb <- train(Triage_Level ~ .,
            data = copd.final.train,
            method = "xgbTree",
            trControl = copd.xgb.traincontrol,
            nthread = 3)

xgb.predict <- predict(xgb, copd.final.test, type = 'raw')

confusionMatrix(xgb.predict, copd.final.test$Triage_Level)

plot(xgb)

###############################################################################
# XGboost - tree 2
###############################################################################
set.seed(1234)
copd.final.train <- subset(copd.train, select = -c(Triage))
copd.final.test <- subset(copd.validation, select = -c(Triage))

levels(copd.final.train$Triage_Level) <- c("Ok", "Plan", "Doc", "ER")
levels(copd.final.test$Triage_Level) <- c("Ok", "Plan", "Doc", "ER")

copd.xgb.traincontrol <- trainControl(
  method = 'cv',
  number = 10,
  classProbs = TRUE,
  verboseIter = TRUE,
  summaryFunction = multiClassSummary)

copd.xgb.grid <- expand.grid(
  eta = 0.3,
  max_depth = 2,
  nrounds = 50,
  subsample = 0.5,
  colsample_bytree = 0.6,
  min_child_weight = 1,
  gamma = 0
)

xgb <- train(Triage_Level ~ .,
            data = copd.final.train,
            method = "xgbTree",
            tuneGrid = copd.xgb.grid,
            trControl = copd.xgb.traincontrol,
            nthread = 5)

xgb.predict <- predict(xgb, copd.final.test, type = 'raw')

confusionMatrix(xgb.predict, copd.final.test$Triage_Level)


###############################################################################
# XGboost - important
###############################################################################
nb.feature <- c(
  "ShortBreath",
  "Cough",
  "Hour_Recent_Worsening",
  "Wheezing",
  "Sputum_Color",
  "Sputum_Production",
  "CurrentDyspnea",
  "CurrentPulseOxy",
  "CurrentFEV1",
  "CurrentHeartRate",
  "CurrentTemperature",
  "Triage_Level")

set.seed(1234)
copd.final.train <- copd.train[, nb.feature]
copd.final.test <- copd.validation[, nb.feature]

levels(copd.final.train$Triage_Level) <- c("Ok", "Plan", "Doc", "ER")
levels(copd.final.test$Triage_Level) <- c("Ok", "Plan", "Doc", "ER")

copd.xgb.traincontrol <- trainControl(
  method = 'cv',
  number = 10,
  classProbs = TRUE,
  verboseIter = TRUE,
  summaryFunction = multiClassSummary)

copd.xgb.grid <- expand.grid(
  eta = 0.3,
  max_depth = 2,
  nrounds = 100,
  subsample = 0.5,
  colsample_bytree = 0.6,
  min_child_weight = 1,
  gamma = 0
)

xgb <- train(Triage_Level ~ .,
            data = copd.final.train,
            method = "xgbTree",
            tuneGrid = copd.xgb.grid,
            trControl = copd.xgb.traincontrol,
            nthread = 3)

xgb.predict <- predict(xgb, copd.final.test, type = 'raw')

confusionMatrix(xgb.predict, copd.final.test$Triage_Level)

```
```{r}
####################################################################
# Plots for results
####################################################################

dev.off()

barplot(c(73,77,73,42,74,64,78,68,56),
        main="The COPD Exacerbation Diagnosis - Algorithms",
        ylab="The Diagnosis Accuracy Rate %",
        xlab="Algorithm",
        names.arg = c("LR","KNN","SVM-L","SVM-R","SVM-P","ANN","XGB","RF","NB"),
        col="lightblue")

barplot(c(58,35,28,38,45,34,33,59,39,78),
        main="The COPD Exacerbation Diagnosis - Dr vs XGB",
        ylab="The Diagnosis Accuracy Rate %",
        xlab="Algorithm/Dr",
        names.arg = c("Dr1","Dr2","Dr3","Dr4","Dr5","Dr6","Dr7","Dr8","Dr9", "XGB"),
        col="steelblue")

barplot(c(58,73,74,78),
        main="Best Performing Dr and algorithms",
        ylab="The Diagnosis Accuracy Rate %",
        xlab="Algorithm/Dr",
        names.arg = c("Dr8","LR","SVM-P","XGB"),
        col="darkgreen")

barplot(c(32,16,12,14),
        main="Under Triaged a Patient by One Level Rate",
        ylab="Rate %",
        xlab="Algorithm/Dr",
        names.arg = c("Dr8","LR","SVM-P", "XGB"),
        col="pink")





```

